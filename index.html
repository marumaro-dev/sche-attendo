<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Eleftis 出欠管理</title>
        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <!-- 外部CSS -->
        <link rel="stylesheet" href="style.css" />

        <!-- Firebase SDK -->
        <script defer src="/__/firebase/12.6.0/firebase-app-compat.js"></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-auth-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-database-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-firestore-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-functions-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-messaging-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-storage-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-analytics-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-remote-config-compat.js"
        ></script>
        <script
            defer
            src="/__/firebase/12.6.0/firebase-performance-compat.js"
        ></script>
        <script defer src="/__/firebase/init.js?useEmulator=false"></script>
    </head>
    <body>
        <div id="app">
            <h1>Eleftis 出欠管理</h1>

            <!-- 一覧画面（eventId なしのときに表示） -->
            <div id="event-list-view">
                <h2>イベント一覧</h2>
                <p>参加する試合・練習・イベントを選んでください。</p>

                <!-- 自分用のまとめ入力ボタン -->
                <button id="open-my-attendance-btn" style="margin-bottom: 8px">
                    自分の出欠をまとめて登録する
                </button>

                <div class="card notice-card">
                    <h3>🗓 翌月分の出欠について</h3>
                    <p>
                        ・翌月分の出欠は、月末までにご回答をお願いします。
                    </p>
                    <h4>🔺「△（未定）」で回答している場合</h4>
                    <p>
                        ・活動日の1週間前までに、「〇」または「✕」へ変更をお願いします。<br />
                        ・1週間を過ぎてから「✕」へ変更する場合は、中橋まで一言ご連絡ください。<br />
                        ※「〇」への変更は連絡不要です。
                    </p>
                    <h4>⏰ 直前まで参加可否が分からない場合</h4>
                    <p>
                        ・いつ頃までに判断できそうかを、中橋までご連絡ください。<br />
                        ・お仕事やご家庭の事情で毎回直前になりやすい方は、<br />
                        　一度ご相談いただければ、以降は未定連絡は不要とします。
                    </p>
                </div>

                <!-- イベント一覧 -->
                <div id="event-list">読み込み中…</div>

                <!-- みんなのメモ -->
                <div id="memo-card" class="card" style="margin-top: 24px">
                    <h2>みんなのメモ</h2>
                    <p style="font-size: 12px; margin-bottom: 8px">
                        共有したいひとことメモを書いてください。
                    </p>

                    <div class="memo-input">
                        <textarea
                            id="memo-input"
                            rows="3"
                            placeholder="例：体調不良予定のため欠席（✖）"
                        ></textarea>
                        <button id="memo-submit-btn" class="pill-button">
                            メモを投稿する
                        </button>
                    </div>

                    <div id="memo-list">まだメモはありません。</div>

                    <button
                        id="memo-load-more-btn"
                        class="ghost-button"
                        style="margin-top: 8px"
                    >
                        もっと見る
                    </button>
                </div>

                <!-- 出席率ランキング（管理者用） -->
                <div id="stats-panel" class="card" style="margin-top: 24px">
                    <h2>出席率ランキング</h2>
                    <p class="note-text">
                        ※ 管理者だけボタンが表示されます。<br />
                        ※ 「出席」と「遅刻」を参加としてカウントします。
                    </p>
                    <button id="load-stats-btn" class="pill-button">
                        出席率を集計する
                    </button>

                    <div id="stats-result" style="margin-top: 8px">
                        未集計です。
                    </div>
                </div>

                <!-- イベント削除（管理者専用） -->
                <div
                    id="admin-event-delete"
                    class="card"
                    style="margin-top: 24px; display: none"
                >
                    <h2>イベント削除（管理者専用）</h2>
                    <p>
                        間違って追加したイベントを削除できます。<br />
                        ※関連する出欠データもすべて削除されます。
                    </p>

                    <label for="delete-event-select">削除するイベント：</label>
                    <select id="delete-event-select">
                        <option value="">
                            -- イベントを選択してください --
                        </option>
                    </select>

                    <div style="margin-top: 8px">
                        <button
                            id="admin-delete-btn"
                            class="pill-button"
                            style="background: #b12234"
                        >
                            選択したイベントを削除する
                        </button>
                    </div>
                </div>

                <!-- 管理者用：イベント追加 / 編集 -->
                <div
                    id="admin-panel"
                    class="card"
                    style="margin-top: 24px; display: none"
                >
                    <h2>管理者用：イベント追加 / 編集</h2>
                    <p style="font-size: 12px; margin-bottom: 4px">
                        ※
                        管理者アカウントでアクセスしたときだけ表示されます。<br />
                        「編集するイベント」を選ぶと、下のフォームに内容が読み込まれます。
                        何も選ばなければ新規追加になります。
                    </p>

                    <!-- 編集対象イベントのセレクト -->
                    <div style="margin-bottom: 8px">
                        <label for="admin-edit-select">
                            編集するイベント（任意）
                        </label>
                        <select id="admin-edit-select">
                            <option value="">新規作成（何も選択しない）</option>
                        </select>
                    </div>

                    <!-- 入力フォーム -->
                    <div
                        style="display: flex; flex-direction: column; gap: 6px"
                    >
                        <label>
                            イベントID（英数字推奨）
                            <input
                                id="admin-event-id"
                                type="text"
                                placeholder="例: 20xx-xx-xx-practice"
                            />
                        </label>

                        <label>
                            試合名 / 練習名（title）
                            <input
                                id="admin-title"
                                type="text"
                                placeholder="例: 練習試合 vs ○○"
                            />
                        </label>

                        <label>
                            種別（type）
                            <select id="admin-type">
                                <option value="">選択なし</option>
                                <option value="official">公式戦</option>
                                <option value="practiceGame">練習試合</option>
                                <option value="practice">練習</option>
                                <option value="event">イベント・その他</option>
                            </select>
                        </label>

                        <label>
                            日付（date）
                            <input id="admin-date" type="date" />
                        </label>

                        <label>
                            時間（time）
                            <input
                                id="admin-time"
                                type="text"
                                placeholder="00:00-23:00"
                            />
                        </label>

                        <label>
                            場所（place）
                            <input
                                id="admin-place"
                                type="text"
                                placeholder="阪神甲子園球場"
                            />
                        </label>

                        <label>
                            メモ（note）
                            <input
                                id="admin-note"
                                type="text"
                                placeholder="集合14:30 / 現地解散"
                            />
                        </label>

                        <button
                            id="admin-save-btn"
                            class="pill-button"
                            style="margin-top: 8px"
                        >
                            イベントを保存
                        </button>
                    </div>

                    <p
                        id="admin-message"
                        style="
                            font-size: 12px;
                            white-space: pre-wrap;
                            margin-top: 8px;
                        "
                    ></p>
                </div>
            </div>
            <!-- /#event-list-view -->

            <!-- 自分の出欠をまとめて登録する画面（最初は非表示） -->
            <div
                id="my-attendance-view"
                style="display: none; margin-top: 16px"
            >
                <button id="back-to-events-btn" style="margin-bottom: 8px">
                    ← イベント一覧に戻る
                </button>

                <h2>自分の出欠一覧</h2>
                <p style="font-size: 12px">
                    各イベントの出欠をまとめて登録できます。
                </p>

                <div id="my-attendance-table">読み込み中…</div>
            </div>

            <!-- イベント詳細画面（eventId ありのときに表示） -->
            <div id="event-detail-view" style="display: none; margin-top: 16px">
                <button id="back-to-list-btn" style="margin-bottom: 8px">
                    ← イベント一覧に戻る
                </button>

                <h2>次の試合</h2>
                <div id="event-info">読み込み中…</div>

                <div id="buttons" style="margin-top: 8px">
                    <button data-status="present">◎ 出席</button>
                    <button data-status="late">〇 遅刻</button>
                    <button data-status="undecided">△ 未定</button>
                    <button data-status="absent">✖ 欠席</button>
                </div>

                <div id="event-memo-card" class="card" style="margin-top: 16px">
                    <h2>イベントメモ</h2>
                    <p class="note-text">
                        個々人がイベントごとにメモを残せます。
                    </p>
                    <div class="memo-input">
                        <textarea
                            id="event-memo-input"
                            rows="3"
                            placeholder="例：布団に捕まっているため当日ギリギリか遅れますZzz"
                        ></textarea>
                        <button
                            id="event-memo-submit-btn"
                            class="pill-button"
                        >
                            メモを投稿する
                        </button>
                    </div>
                    <div id="event-memo-list">まだメモはありません。</div>
                    <button
                        id="event-memo-load-more-btn"
                        class="ghost-button"
                        style="margin-top: 8px"
                    >
                        もっと見る
                    </button>
                </div>

                <h2 style="margin-top: 16px">メンバーの出欠状況</h2>

                <div
                    id="attendance-summary"
                    style="font-size: 12px; margin-bottom: 4px"
                >
                    ◎ 出席: <span id="sum-present">0</span>人　 〇 遅刻:<span
                        id="sum-late"
                        >0</span
                    >人　 △ 未定:<span id="sum-undecided">0</span>人　 ✖
                    欠席:<span id="sum-absent">0</span>人　 未回答:<span
                        id="sum-noresp"
                        >0</span
                    >人　
                </div>

                <div id="attendance-list">読み込み中…</div>

                <!-- オーダー（守備・打順）ブロック -->
                <div id="lineup-block" style="display: none; margin-top: 16px">
                    <h2>オーダー（守備・打順）</h2>
                    <p class="note-text">
                        公式戦・練習試合のときに使用します。<br />
                        出席（◎）・遅刻（〇）になっているメンバーだけ選択できます。
                    </p>

                    <!-- JS で中身が描画されるコンテナ -->
                    <div id="lineup-editor">読み込み中…</div>

                    <button
                        id="lineup-save-btn"
                        class="pill-button"
                        style="margin-top: 8px"
                    >
                        オーダーを保存する
                    </button>
                </div>

                <hr />
            </div>
        </div>

        <!-- LIFF SDK -->
        <script
            defer
            src="https://static.line-scdn.net/liff/edge/2/sdk.js"
        ></script>
        <!-- アプリ本体 -->
        <script defer src="app.js"></script>
    </body>
</html>
